# vim:ft=python
#
# SPDX-License-Identifier: BSD-2-Clause
#
# Copyright (c) 2023 Mysterious Code Ltd.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
# notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
# notice, this list of conditions and the following disclaimer in the
# documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#
# Copyright (c) 2016-2018 Jonathan Anderson
# All rights reserved.
#
# This software was developed at Memorial University under the
# NSERC Discovery program (RGPIN-2015-06048).
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
# notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
# notice, this list of conditions and the following disclaimer in the
# documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#

import os
import sys

try:
    import lit
except ModuleNotFoundError:
    # in case of llvm-devel
    import lit_devel as lit

#
# Basic information about this test suite.
#
config.name = 'libpreopen'
config.suffixes = ['.c', ]
config.excludes = ['Inputs', ]
config.test_format = lit.formats.ShTest()


def bootstrap_configuration(config):
    """
    Find all of the configuration information that is normally supplied by
    CMake via a lit.site.cfg file.

    When lit is used to execute a single test (e.g., `lit ../../test/shm.c`),
    it may not find the lit.site.cfg file that has been generated by CMake to
    tell it where to find source directories, FileCheck, etc. This function
    attempts to find that information using path heuristics, environment
    variables, etc., in order to make the developer's life easier. To get
    deterministic behaviour (e.g., when doing continuous integration), you
    should just use the CMake-generated `check` target, i.e., `make check` or
    `ninja check`.
    """

    # Find the 'test_support' module:
    config.source_root = os.getenv('LIBPREOPEN_SOURCE_DIR')
    if not config.source_root:
        if not 'source_dir' in lit_config.params:
            raise Exception('Unable to find LIBPREOPEN source directory.'
                            + ' Set LIBPREOPEN_SOURCE_DIR or pass'
                            + ' --param=source_dir=path/to/src to lit')
        config.source_root = lit_config.params['source_dir']
    sys.path.append(os.path.join(config.source_root, 'test'))

    try:
        import test_support as test
    except ImportError as e:
        print("Unable to find 'test_support' module in:\n[")
        for p in sys.path:
            print("  %s" % p)
        print("]")
        sys.exit(1)

    # Find tools to be used at test run time (C compiler, FileCheck, etc.):
    try:
        config.cc = test.which(['cc', 'clang', ])
        config.filecheck_path = test.which(['FileCheck', ])
    except ValueError as e:
        sys.stderr.write(e.args[0] + '\n')
        sys.exit(1)

    # Test CFLAGS:
    extra_cflags = ['-Wall', '-g', ]  # always build tests with debug symbols
    extra_cflags += ['-I', os.path.join(config.source_root, 'include'), ]

    config.cflags = test.cflags(['%p/Inputs'], extra=extra_cflags)

    # The built libpreopen library:
    config.build_root = os.getenv('LIBPREOPEN_BUILD_DIR')
    if not config.build_root:
        if not 'build_root' in lit_config.params:
            raise Exception('Unable to find LIBPREOPEN build directory;' +
                            ' set LIBPREOPEN_BUILD_DIR or pass --build_root to lit')
        config.build_root = lit_config.params['build_root']

    libdir = os.path.join(config.build_root, 'lib')
    config.environment['LD_LIBRARY_PATH'] = libdir
    config.ldflags = test.ldflags([libdir, ], ['preopen', ])
    config.library = test.find_library(test.libname('preopen'), [libdir, ])

    config.test_exec_root = os.path.join(config.build_root, 'test', 'Output')


#
# Do we have paths, etc., from a site-specific lit.site.cfg file or do we need
# to bootstrap such a configuration?
#
if hasattr(config, 'source_root'):
    pass
else:
    bootstrap_configuration(config)

#
# Set variables that we can access from lit RUN lines.
#
config.substitutions += [
    # Tools:
    ('%cc', config.cc),
    ('%filecheck', config.filecheck_path),

    # The library:
    ('%lib', config.library),

    # Flags:
    ('%cflags', config.cflags),
    ('%ldflags', config.ldflags),
]
